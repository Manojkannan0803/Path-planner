classdef TestDataManager < handle
    % TestDataManager - Utility class for managing test data and configurations
    % 
    % This class provides utilities for creating, managing, and cleaning up
    % test data files used by the regression test suite.
    %
    % Package: +Planner.+Testing
    % Date: 2025-09-23
    
    properties (Constant)
        TEST_DATA_DIR = '+Planner/+Testing/TestData'
    end
    
    properties (Access = private)
        createdFiles = {}
        createdDirs = {}
    end
    
    methods (Static)
        function manager = getInstance()
            % Singleton pattern for test data manager
            persistent instance
            if isempty(instance) || ~isvalid(instance)
                instance = Planner.Testing.TestDataManager();
            end
            manager = instance;
        end
        
        function configContent = getValidVehicleConfig()
            % Returns a valid vehicle configuration YAML content
            configContent = sprintf([...
                '# Test Vehicle Configuration - Generated by TestDataManager\n',...
                'vehicle:\n',...
                '  length: 4.07\n',...
                '  width: 1.75\n',...
                '  wheelbase: 2.55\n',...
                '  rear_axle_distance: 1.53\n',...
                '  max_steering_angle: 44\n',...
                '  max_steering_rate: 35\n',...
                '  min_turning_radius: 2.64\n',...
                '  max_velocity: 8.0\n',...
                '  max_acceleration: 2.5\n',...
                '  max_jerk: 1.5\n',...
                '  safety_margin_static: 0.75\n',...
                '  safety_margin_dynamic: 1.5\n',...
                '  emergency_stop_distance: 2.0\n',...
                '\n',...
                'planning:\n',...
                '  global_planner_timeout: 1250\n',...
                '  replan_timeout: 200\n',...
                '  max_planning_iterations: 10000\n',...
                '  spatial_resolution: 0.25\n',...
                '  angular_resolution: 7.5\n',...
                '  cost_weights:\n',...
                '    length: 1.0\n',...
                '    time: 0.8\n',...
                '    comfort: 0.6\n',...
                '    efficiency: 0.4\n',...
                '    reverse_penalty: 2.0\n',...
                '\n',...
                'environment:\n',...
                '  max_obstacles: 50\n',...
                '  max_dynamic_objects: 3\n',...
                '  parking_space_width: 2.3\n',...
                '  planning_horizon: 30.0\n',...
                '\n',...
                'simulation:\n',...
                '  base_sample_time: 0.02\n',...
                '  global_planner_rate: 1.0\n',...
                '  local_adapter_rate: 20.0\n',...
                '  trajectory_gen_rate: 50.0\n',...
                '  safety_monitor_rate: 100.0\n']);
        end
        
        function configContent = getInvalidVehicleConfig(errorType)
            % Returns invalid vehicle configuration for testing error handling
            % errorType: 'negative_length', 'invalid_wheelbase', 'missing_required'
            
            switch errorType
                case 'negative_length'
                    configContent = sprintf([...
                        'vehicle:\n',...
                        '  length: -4.07\n',...  % Invalid negative
                        '  width: 1.75\n',...
                        '  wheelbase: 2.55\n',...
                        '  rear_axle_distance: 1.53\n',...
                        '  max_steering_angle: 44\n',...
                        '  max_steering_rate: 35\n',...
                        '  min_turning_radius: 2.64\n',...
                        '  max_velocity: 8.0\n',...
                        '  max_acceleration: 2.5\n',...
                        '  max_jerk: 1.5\n',...
                        '  safety_margin_static: 0.75\n',...
                        '  safety_margin_dynamic: 1.5\n',...
                        '  emergency_stop_distance: 2.0\n']);
                        
                case 'invalid_wheelbase'
                    configContent = sprintf([...
                        'vehicle:\n',...
                        '  length: 4.07\n',...
                        '  width: 1.75\n',...
                        '  wheelbase: 5.0\n',...  % Invalid: larger than length
                        '  rear_axle_distance: 1.53\n',...
                        '  max_steering_angle: 44\n',...
                        '  max_steering_rate: 35\n',...
                        '  min_turning_radius: 2.64\n',...
                        '  max_velocity: 8.0\n',...
                        '  max_acceleration: 2.5\n',...
                        '  max_jerk: 1.5\n',...
                        '  safety_margin_static: 0.75\n',...
                        '  safety_margin_dynamic: 1.5\n',...
                        '  emergency_stop_distance: 2.0\n']);
                        
                case 'missing_required'
                    configContent = sprintf([...
                        'vehicle:\n',...
                        '  length: 4.07\n',...
                        '  width: 1.75\n']);  % Missing required fields
                        
                otherwise
                    error('TestDataManager:InvalidErrorType', ...
                        'Unknown error type: %s', errorType);
            end
        end
        
        function configContent = getMinimalValidConfig()
            % Returns minimal valid configuration for edge case testing
            configContent = sprintf([...
                'vehicle:\n',...
                '  length: 3.0\n',...
                '  width: 1.5\n',...
                '  wheelbase: 2.0\n',...
                '  rear_axle_distance: 1.0\n',...
                '  max_steering_angle: 30\n',...
                '  max_steering_rate: 20\n',...
                '  min_turning_radius: 3.46\n',...
                '  max_velocity: 5.0\n',...
                '  max_acceleration: 1.5\n',...
                '  max_jerk: 1.0\n',...
                '  safety_margin_static: 0.1\n',...
                '  safety_margin_dynamic: 0.2\n',...
                '  emergency_stop_distance: 1.0\n',...
                '\n',...
                'planning:\n',...
                '  global_planner_timeout: 500\n',...
                '  replan_timeout: 100\n',...
                '  max_planning_iterations: 1000\n',...
                '  spatial_resolution: 0.5\n',...
                '  angular_resolution: 15.0\n',...
                '  cost_weights:\n',...
                '    length: 1.0\n',...
                '    time: 0.5\n',...
                '    comfort: 0.3\n',...
                '    efficiency: 0.2\n',...
                '    reverse_penalty: 1.5\n',...
                '\n',...
                'environment:\n',...
                '  max_obstacles: 10\n',...
                '  max_dynamic_objects: 1\n',...
                '  parking_space_width: 2.0\n',...
                '  planning_horizon: 15.0\n',...
                '\n',...
                'simulation:\n',...
                '  base_sample_time: 0.05\n',...
                '  global_planner_rate: 0.5\n',...
                '  local_adapter_rate: 10.0\n',...
                '  trajectory_gen_rate: 20.0\n',...
                '  safety_monitor_rate: 50.0\n']);
        end
    end
    
    methods
        function obj = TestDataManager()
            % Constructor
            obj.ensureTestDataDir();
        end
        
        function filename = createTempConfigFile(obj, content, prefix)
            % Create temporary configuration file
            if nargin < 3
                prefix = 'temp_config';
            end
            
            timestamp = datestr(now, 'yyyy-mm-dd_HH-MM-SS-FFF');
            filename = fullfile(obj.TEST_DATA_DIR, ...
                sprintf('%s_%s.yaml', prefix, timestamp));
            
            fid = fopen(filename, 'w');
            if fid == -1
                error('TestDataManager:FileCreationFailed', ...
                    'Could not create file: %s', filename);
            end
            
            fprintf(fid, '%s', content);
            fclose(fid);
            
            obj.createdFiles{end+1} = filename;
        end
        
        function cleanupTempFiles(obj)
            % Clean up all temporary files created by this instance
            for i = 1:numel(obj.createdFiles)
                if isfile(obj.createdFiles{i})
                    delete(obj.createdFiles{i});
                end
            end
            obj.createdFiles = {};
            
            for i = 1:numel(obj.createdDirs)
                if isfolder(obj.createdDirs{i})
                    rmdir(obj.createdDirs{i}, 's');
                end
            end
            obj.createdDirs = {};
        end
        
        function ensureTestDataDir(obj)
            % Ensure test data directory exists
            if ~isfolder(obj.TEST_DATA_DIR)
                mkdir(obj.TEST_DATA_DIR);
                obj.createdDirs{end+1} = obj.TEST_DATA_DIR;
            end
        end
    end
    
    methods (Static)
        function cleanupAllTestData()
            % Static method to clean up all test data (use with caution)
            testDir = Planner.Testing.TestDataManager.TEST_DATA_DIR;
            if isfolder(testDir)
                % Only delete files, not the directory itself
                files = dir(fullfile(testDir, '*.yaml'));
                for i = 1:numel(files)
                    delete(fullfile(testDir, files(i).name));
                end
                
                files = dir(fullfile(testDir, 'temp_*'));
                for i = 1:numel(files)
                    if files(i).isdir
                        rmdir(fullfile(testDir, files(i).name), 's');
                    else
                        delete(fullfile(testDir, files(i).name));
                    end
                end
            end
        end
    end
end